<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Cliente | JL Serviços</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #bd9617; --dark-blue: #0a192f; --glass: rgba(255, 255, 255, 0.05); }
        body { background: var(--dark-blue); color: white; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; }
        .sidebar { width: 250px; height: 100vh; background: rgba(0,0,0,0.3); border-right: 1px solid rgba(189, 150, 23, 0.2); padding: 30px 20px; display: flex; flex-direction: column; position: sticky; top: 0; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .welcome-section h1 { font-family: 'Playfair Display', serif; font-size: 2.2rem; margin: 0; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .card { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; transition: 0.3s; }
        .card:hover { border-color: var(--gold); transform: translateY(-5px); }
        .card i { font-size: 2rem; color: var(--gold); margin-bottom: 15px; display: block; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .btn-action { background: var(--gold); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: 600; }
        .logout-btn { margin-top: auto; color: #ff4444; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .doc-item { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color: var(--gold); font-family: 'Playfair Display';">JL Painel</h2>
        <nav style="margin-top: 40px;">
            <p style="font-size: 0.8rem; color: #888;">Navegação</p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <a href="#" style="color: var(--gold); text-decoration: none;"><i class="fas fa-home"></i> Início</a>
            </div>
        </nav>
        <a onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair do Painel</a>
    </aside>

    <main class="main-content">
        <section class="welcome-section">
            <h1 id="user-name">Carregando...</h1>
            <p id="user-email" style="color: #888;"></p>
        </section>

        <div class="dashboard-grid">
            <div class="card">
                <i class="fas fa-id-card"></i>
                <h3>Sua Assinatura</h3>
                <p style="font-size: 0.9rem;">Status: <span id="sub-status" class="status-badge">Verificando...</span></p>
                <p id="sub-details" style="font-size: 0.8rem; color: #aaa;">Carregando plano...</p>
            </div>

            <div class="card">
                <i class="fas fa-folder-open"></i>
                <h3>Meus Documentos</h3>
                <div id="lista-documentos" style="max-height: 250px; overflow-y: auto; margin-top:15px;">
                    <p style="font-size: 0.8rem; color: #888;">Buscando arquivos...</p>
                </div>
                <button class="btn-action" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Atualizar Lista
                </button>
            </div>

            <div class="card">
                <i class="fab fa-whatsapp"></i>
                <h3>Suporte Direto</h3>
                <p style="font-size: 0.9rem;">Dúvidas? Fale com a contabilidade.</p>
                <button class="btn-action" style="background: #25d366;" onclick="abrirWhatsapp()">
                    Iniciar Chat
                </button>
            </div>
        </div>
    </main>

    <script>
        const SB_URL = 'https://qdgsmnfhpbkbovptwwjp.supabase.co';
        const SB_KEY = 'SUA_KEY_ANON_AQUI'; 
        const dashClient = supabase.createClient(SB_URL, SB_KEY);

        const nomesServicos = {
            'abertura-mei': 'Abertura de MEI', 
            'mei-plano-basico': 'Plano MEI Básico', 
            'mei-plano-premium': 'Plano MEI Premium', 
            'irpf': 'Declaração IRPF'
        };

        async function logout() {
            await dashClient.auth.signOut();
            window.location.href = '../../index.html'; // Ajustado para voltar da pasta servicos/area_do_cliente
        }

        function abrirWhatsapp(msg = "Olá! Sou cliente JL e preciso de suporte.") {
            window.open(`https://wa.me/5561920041427?text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function verificarAcesso() {
            const { data: { user } } = await dashClient.auth.getUser();

            if (!user) {
                window.location.href = '../../index.html';
                return;
            }

            // BOTÃO DO ADMIN - Troque pelo seu e-mail real
            const EMAIL_ADMIN = "jlservicoscontabeis0@gmail.com"; 
            if (user.email === EMAIL_ADMIN) {
                const btnAdmin = document.createElement('button');
                btnAdmin.innerHTML = '<i class="fas fa-user-shield"></i> Voltar ao Admin';
                btnAdmin.style = "position:fixed; bottom:20px; right:20px; background:#bd9617; color:white; border:none; padding:12px 20px; border-radius:30px; z-index:9999; cursor:pointer; font-weight:bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);";
                btnAdmin.onclick = () => window.location.href = 'admin.html';
                document.body.appendChild(btnAdmin);
            }

            // Carregar Perfil e Documentos (Correção de nomes de tabela)
            const { data: profile } = await dashClient.from('profiles').select('*').eq('id', user.id).single();
            const { data: assinatura } = await dashClient.from('assinaturas').select('*').eq('cliente_id', user.id).order('created_at', { ascending: false }).limit(1).maybeSingle();
            const { data: docs } = await dashClient.from('documentos').select('*').eq('cliente_id', user.id).order('created_at', { ascending: false });

            // Atualiza UI
            document.getElementById('user-name').innerText = "Olá, " + (profile?.nome?.split(' ')[0] || user.email.split('@')[0]);
            document.getElementById('user-email').innerText = user.email;

            // Status Badge
            const statusBadge = document.getElementById('sub-status');
            const status = assinatura?.status || "Inativo";
            statusBadge.innerText = status;
            statusBadge.style.background = status === 'Ativo' ? '#25d366' : (status === 'Pendente' ? '#f1c40f' : '#ff4444');
            statusBadge.style.color = status === 'Pendente' ? 'black' : 'white';
            document.getElementById('sub-details').innerText = nomesServicos[assinatura?.plano_id] || "Nenhum serviço ativo";

            // Lista Documentos
            const listaDocs = document.getElementById('lista-documentos');
            if (docs?.length > 0) {
                listaDocs.innerHTML = docs.map(doc => `
                    <div class="doc-item">
                        <span style="font-size:0.8rem;"><i class="far fa-file-pdf" style="color:#ff4444;"></i> ${doc.nome_arquivo}</span>
                        <a href="${doc.url_arquivo}" target="_blank" style="color:var(--gold); text-decoration:none; font-size:0.7rem; font-weight:bold;">BAIXAR</a>
                    </div>
                `).join('');
            } else {
                listaDocs.innerHTML = "<p style='font-size:0.7rem; color:#666;'>Nada disponível ainda.</p>";
            }

            // Lógica de Checkout Automático (Seu código original chamando a nova função)
            const urlParams = new URLSearchParams(window.location.search);
            const servico = urlParams.get('contratar');
            if (servico) iniciarFluxoContratacao(user, servico, profile);
        }

        async function iniciarFluxoContratacao(user, servicoID, profile) {
            console.log("Iniciando contratação para:", servicoID);
            try {
                // 1. Verificar duplicidade
                const { data: existente } = await dashClient
                    .from('assinaturas')
                    .select('*')
                    .eq('cliente_id', user.id)
                    .eq('plano_id', servicoID)
                    .in('status', ['Pendente', 'Ativo'])
                    .maybeSingle();

                if (existente) {
                    alert(`Você já possui uma solicitação para ${nomesServicos[servicoID] || servicoID}.`);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                // 2. Registrar no banco
                const { error: insError } = await dashClient.from('assinaturas').insert({
                    cliente_id: user.id,
                    plano_id: servicoID,
                    status: 'Pendente'
                });

                if (insError) throw insError;

                // 3. Notificar via WhatsApp
                const nomeCliente = profile?.nome || user.email;
                const nomeServico = nomesServicos[servicoID] || servicoID;
                const mensagem = `Olá! Meu nome é ${nomeCliente}. Acabei de solicitar o serviço *${nomeServico}* pelo site e gostaria de prosseguir com o atendimento.`;
                
                alert("Solicitação registrada! Vamos te redirecionar para o WhatsApp.");
                window.history.replaceState({}, document.title, window.location.pathname);
                
                setTimeout(() => {
                    abrirWhatsapp(mensagem);
                    location.reload();
                }, 1000);

            } catch (err) {
                alert("Erro ao processar pedido: " + err.message);
            }
        }

        // Executa a verificação ao carregar a página
        verificarAcesso();
    </script>
</body>
</html>
